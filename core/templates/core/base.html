<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App IA - Baby Safe</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-top: 20px; background-color: #f8f9fa; }
        .container { max-width: 800px; }
        .chat-box { height: 400px; overflow-y: scroll; border: 1px solid #ccc; background: white; padding: 15px; margin-bottom: 15px; border-radius: 10px;}
        .message { margin-bottom: 10px; padding: 10px; border-radius: 10px; }
        .user-msg { background-color: #e3f2fd; text-align: right; margin-left: 20%; }
        .bot-msg { background-color: #f1f0f0; text-align: left; margin-right: 20%; }
        img.chat-img { max-width: 200px; display: block; margin-top: 5px; border-radius: 5px; margin-left: auto; }
        .bot-msg img.chat-img { margin-right: auto; margin-left: initial; }
    </style>
</head>
<body>
    <div class="container">
        {% block content %}{% endblock %}
        <hr class="mt-5">
        <div class="d-flex justify-content-center gap-3 mb-5">
            <a href="{% url 'home' %}" class="btn btn-outline-secondary">Home</a>
            <a href="{% url 'clasificacion' %}" class="btn btn-outline-primary">Chat IA</a>
        </div>
    </div>

    <!-- Firebase Initialization Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        let configString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
        let firebaseConfig = {};
        let isFallback = false;

        // Configuración de FALLBACK
        const FALLBACK_CONFIG = {
            apiKey: "AIzaSy_FALLBACK_KEY", // Esta es la clave que falla la autenticación
            projectId: "fallback-project",
            authDomain: "fallback-auth.firebaseapp.com"
        };
        
        try {
            if (configString.trim() && configString !== 'null' && configString !== 'undefined') {
                let parsed = JSON.parse(configString);
                if (parsed && typeof parsed === 'object' && !Array.isArray(parsed) && parsed.apiKey) {
                    firebaseConfig = parsed;
                }
            }
        } catch (e) {
            console.warn("ADVERTENCIA: Error al parsear la configuración de Firebase.");
        }

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.apiKey) {
            console.error("ERROR CRÍTICO: La configuración del entorno es inválida. Usando configuración de RESERVA. Saltando la autenticación para evitar el error 'API key not valid'.");
            firebaseConfig = FALLBACK_CONFIG;
            isFallback = true;
        }
        
        // --- INICIALIZACIÓN ---
        
        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        
        if (isFallback) {
            // ** SOLUCIÓN DE FALLBACK: Si no hay clave válida, evitamos la autenticación que falla. **
            // Esto permite que el historial y el chat sigan funcionando con un ID de sesión.
            window.userId = crypto.randomUUID(); // Generar un ID temporal
            window.appId = appId;
            window.firebaseReady = true; 
            console.warn("MODO FALLBACK ACTIVO. La persistencia de datos en Firestore puede ser limitada o fallar.");

        } else {
            // ** FLUJO DE AUTENTICACIÓN NORMAL (Si la clave API es real) **
            const auth = getAuth(app);
            async function authenticate() {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                    
                    window.userId = auth.currentUser?.uid || crypto.randomUUID();
                    window.appId = appId;
                    window.firebaseReady = true; 
                    console.log("Firebase y Usuario listos:", window.userId);

                } catch (error) {
                    console.error("Error en la autenticación de Firebase:", error);
                    window.firebaseReady = false; 
                }
            }
            
            authenticate();
        }
    </script>
</body>
</html>